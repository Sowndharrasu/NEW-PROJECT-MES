{% extends "base.html" %}

{% block title %}{{ title }} - Manufacturing ERP System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h1 class="h3 mb-3">
            <i class="fas fa-shopping-cart me-2"></i>{{ title }}
        </h1>
    </div>
    <div class="col-md-6 text-end">
        <a href="{{ url_for('main.purchase_orders_list') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to List
        </a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST">
            {{ form.hidden_tag() }}
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.po_number.label(class="form-label") }}
                        {% if form.po_number.errors %}
                            {{ form.po_number(class="form-control is-invalid") }}
                            <div class="invalid-feedback">
                                {% for error in form.po_number.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ form.po_number(class="form-control") }}
                        {% endif %}
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.vendor_id.label(class="form-label") }}
                        {% if form.vendor_id.errors %}
                            {{ form.vendor_id(class="form-select is-invalid", id="vendorSelect") }}
                            <div class="invalid-feedback">
                                {% for error in form.vendor_id.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ form.vendor_id(class="form-select", id="vendorSelect") }}
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.po_date.label(class="form-label") }}
                        {% if form.po_date.errors %}
                            {{ form.po_date(class="form-control is-invalid") }}
                            <div class="invalid-feedback">
                                {% for error in form.po_date.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ form.po_date(class="form-control") }}
                        {% endif %}
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.delivery_date.label(class="form-label") }}
                        {% if form.delivery_date.errors %}
                            {{ form.delivery_date(class="form-control is-invalid") }}
                            <div class="invalid-feedback">
                                {% for error in form.delivery_date.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ form.delivery_date(class="form-control") }}
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.total_amount.label(class="form-label") }}
                        {% if form.total_amount.errors %}
                            {{ form.total_amount(class="form-control is-invalid", step="0.01") }}
                            <div class="invalid-feedback">
                                {% for error in form.total_amount.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ form.total_amount(class="form-control", step="0.01") }}
                        {% endif %}
                        <div class="form-text">Total value including taxes and charges</div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.status.label(class="form-label") }}
                        {% if form.status.errors %}
                            {{ form.status(class="form-select is-invalid") }}
                            <div class="invalid-feedback">
                                {% for error in form.status.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ form.status(class="form-select") }}
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="mb-3">
                        {{ form.terms_and_conditions.label(class="form-label") }}
                        {% if form.terms_and_conditions.errors %}
                            {{ form.terms_and_conditions(class="form-control is-invalid", rows="5") }}
                            <div class="invalid-feedback">
                                {% for error in form.terms_and_conditions.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ form.terms_and_conditions(class="form-control", rows="5", placeholder="Enter terms and conditions, payment terms, delivery conditions, etc.") }}
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Vendor Information Display -->
            <div id="vendorInfo" class="alert alert-info d-none" role="alert">
                <h6><i class="fas fa-info-circle me-2"></i>Vendor Information</h6>
                <div id="vendorDetails"></div>
            </div>
            
            <div class="alert alert-warning" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Purchase Order Guidelines:</strong>
                <ul class="mb-0 mt-2">
                    <li>Ensure all specifications and quantities are clearly defined</li>
                    <li>Include delivery terms, payment conditions, and quality requirements</li>
                    <li>Verify vendor details and contact information</li>
                    <li>After creating, you can add line items to specify materials and quantities</li>
                    <li>Send the PO to vendor only after thorough review</li>
                </ul>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Purchase Order
                    </button>
                    <a href="{{ url_for('main.purchase_orders_list') }}" class="btn btn-secondary ms-2">
                        Cancel
                    </a>
                    <button type="button" class="btn btn-outline-info ms-2" data-bs-toggle="modal" data-bs-target="#templateModal">
                        <i class="fas fa-file-alt me-2"></i>Use Template
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Template Modal -->
<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Standard Terms & Conditions Templates</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Standard Terms</h6>
                        <div class="list-group">
                            <button type="button" class="list-group-item list-group-item-action" 
                                    onclick="useTemplate('standard')">
                                Standard Purchase Terms
                            </button>
                            <button type="button" class="list-group-item list-group-item-action" 
                                    onclick="useTemplate('materials')">
                                Raw Materials Purchase
                            </button>
                            <button type="button" class="list-group-item list-group-item-action" 
                                    onclick="useTemplate('equipment')">
                                Equipment Purchase
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Custom Templates</h6>
                        <div class="list-group">
                            <button type="button" class="list-group-item list-group-item-action" 
                                    onclick="useTemplate('urgent')">
                                Urgent Delivery
                            </button>
                            <button type="button" class="list-group-item list-group-item-action" 
                                    onclick="useTemplate('consignment')">
                                Consignment Purchase
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const vendorSelect = document.getElementById('vendorSelect');
    const vendorInfo = document.getElementById('vendorInfo');
    const vendorDetails = document.getElementById('vendorDetails');
    
    // Set default PO date to today
    const poDateInput = document.querySelector('input[name="po_date"]');
    if (poDateInput && !poDateInput.value) {
        poDateInput.value = new Date().toISOString().split('T')[0];
    }
    
    // Set default delivery date to 14 days from now
    const deliveryDateInput = document.querySelector('input[name="delivery_date"]');
    if (deliveryDateInput && !deliveryDateInput.value) {
        const deliveryDate = new Date();
        deliveryDate.setDate(deliveryDate.getDate() + 14);
        deliveryDateInput.value = deliveryDate.toISOString().split('T')[0];
    }
    
    vendorSelect.addEventListener('change', function() {
        // In a real application, this would fetch vendor details via AJAX
        if (this.value) {
            vendorDetails.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>Selected Vendor:</strong> ${this.options[this.selectedIndex].text}<br>
                        <strong>Contact:</strong> Contact information would be loaded here
                    </div>
                    <div class="col-md-6">
                        <strong>Address:</strong> Vendor address would be displayed<br>
                        <strong>Payment Terms:</strong> Standard payment terms
                    </div>
                </div>
            `;
            vendorInfo.classList.remove('d-none');
        } else {
            vendorInfo.classList.add('d-none');
        }
    });
});

function useTemplate(templateType) {
    const termsTextarea = document.querySelector('textarea[name="terms_and_conditions"]');
    let template = '';
    
    switch(templateType) {
        case 'standard':
            template = `TERMS AND CONDITIONS:

1. PAYMENT: Net 30 days from invoice date
2. DELIVERY: As per delivery schedule mentioned above
3. QUALITY: All materials must meet specified quality standards
4. INSPECTION: Buyer reserves the right to inspect goods upon delivery
5. WARRANTY: 12 months warranty on all supplied items
6. RETURNS: Defective items can be returned within 7 days
7. COMPLIANCE: All applicable taxes and duties to be borne by supplier
8. FORCE MAJEURE: Neither party liable for delays due to circumstances beyond control

GENERAL CONDITIONS:
- All prices are firm and not subject to change
- Delivery charges extra unless specifically mentioned
- Supplier to provide delivery challan and tax invoice`;
            break;
            
        case 'materials':
            template = `RAW MATERIALS PURCHASE TERMS:

1. QUALITY SPECIFICATIONS: All materials must conform to technical specifications
2. TESTING: Material testing certificates to be provided
3. PACKAGING: Proper packaging to prevent damage during transit
4. BATCH TRACKING: Each batch to be clearly marked with batch number and date
5. SHELF LIFE: Minimum 80% shelf life remaining at time of delivery
6. STORAGE: Supplier responsible for proper storage until delivery
7. PAYMENT: 30 days credit after satisfactory quality inspection
8. REJECTION: Buyer reserves right to reject non-conforming materials`;
            break;
            
        case 'equipment':
            template = `EQUIPMENT PURCHASE TERMS:

1. INSTALLATION: Supplier to provide installation and commissioning
2. TRAINING: Operator training to be provided by supplier
3. WARRANTY: 24 months comprehensive warranty
4. SPARE PARTS: Spare parts availability for minimum 10 years
5. SERVICE: Annual maintenance contract available
6. DOCUMENTATION: Complete operation and maintenance manuals
7. COMPLIANCE: Equipment to meet all safety and regulatory standards
8. ACCEPTANCE: Final acceptance after successful trial run`;
            break;
            
        case 'urgent':
            template = `URGENT DELIVERY TERMS:

1. DELIVERY: Delivery required within 48-72 hours
2. PRIORITY: This is an urgent requirement - expedited processing required
3. CHARGES: Rush delivery charges acceptable
4. CONFIRMATION: Immediate delivery confirmation required
5. TRACKING: Shipment tracking details to be provided
6. CONTACT: 24/7 contact person details required
7. PAYMENT: Advance payment may be considered for urgent orders`;
            break;
            
        case 'consignment':
            template = `CONSIGNMENT PURCHASE TERMS:

1. OWNERSHIP: Materials remain vendor property until consumed
2. STORAGE: Vendor maintains inventory at buyer's premises
3. CONSUMPTION: Payment only for materials actually consumed
4. INVENTORY: Monthly stock reconciliation required
5. MINIMUM STOCK: Vendor to maintain minimum stock levels
6. RETURNS: Unused materials returnable to vendor
7. INSURANCE: Vendor responsible for insurance of consignment stock`;
            break;
    }
    
    termsTextarea.value = template;
    bootstrap.Modal.getInstance(document.getElementById('templateModal')).hide();
}
</script>
{% endblock %}
