{% extends "base.html" %}

{% block title %}Reports Dashboard - Manufacturing ERP System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="h3 mb-3">
            <i class="fas fa-chart-bar me-2"></i>Reports & Analytics Dashboard
        </h1>
        <p class="text-muted">Comprehensive insights into manufacturing operations and performance</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary" onclick="refreshData()">
                <i class="fas fa-sync-alt me-2"></i>Refresh Data
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="exportReports()">
                <i class="fas fa-download me-2"></i>Export
            </button>
        </div>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="row g-4 mb-5">
    <div class="col-sm-6 col-xl-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-1">{{ stats.production.completion_rate }}%</h4>
                        <p class="mb-0">Production Efficiency</p>
                        <small class="opacity-75">{{ stats.production.completed_work_orders }}/{{ stats.production.total_work_orders }} completed</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-industry fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-sm-6 col-xl-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-1">{{ stats.quality.pass_rate }}%</h4>
                        <p class="mb-0">Quality Pass Rate</p>
                        <small class="opacity-75">{{ stats.quality.passed_inspections }}/{{ stats.quality.total_inspections }} passed</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-shield-alt fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-sm-6 col-xl-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-1">{{ stats.inventory.stock_health }}%</h4>
                        <p class="mb-0">Inventory Health</p>
                        <small class="opacity-75">{{ stats.inventory.low_stock_tools }} items low stock</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-warehouse fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-sm-6 col-xl-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-1">{{ stats.procurement.fulfillment_rate }}%</h4>
                        <p class="mb-0">Procurement Efficiency</p>
                        <small class="opacity-75">{{ stats.procurement.pending_pos }} POs pending</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-shopping-cart fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row g-4 mb-4">
    <!-- Production Trends -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Production Trends
                </h5>
            </div>
            <div class="card-body">
                <canvas id="productionChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Quality Distribution -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Quality Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="qualityChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analytics -->
<div class="row g-4 mb-4">
    <!-- Work Order Status -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tasks me-2"></i>Work Order Status Overview
                </h5>
            </div>
            <div class="card-body">
                <canvas id="workOrderChart" height="250"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Inventory Status -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-boxes me-2"></i>Inventory Status
                </h5>
            </div>
            <div class="card-body">
                <canvas id="inventoryChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Performance Metrics Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>Detailed Performance Metrics
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Current Value</th>
                                <th>Target</th>
                                <th>Status</th>
                                <th>Trend</th>
                                <th>Action Required</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Production Efficiency</strong></td>
                                <td>{{ stats.production.completion_rate }}%</td>
                                <td>85%</td>
                                <td>
                                    {% if stats.production.completion_rate >= 85 %}
                                    <span class="badge bg-success">On Target</span>
                                    {% elif stats.production.completion_rate >= 70 %}
                                    <span class="badge bg-warning">Below Target</span>
                                    {% else %}
                                    <span class="badge bg-danger">Critical</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <i class="fas fa-arrow-up text-success"></i>
                                </td>
                                <td>
                                    {% if stats.production.completion_rate < 85 %}
                                    Review production bottlenecks
                                    {% else %}
                                    Maintain current performance
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Quality Pass Rate</strong></td>
                                <td>{{ stats.quality.pass_rate }}%</td>
                                <td>95%</td>
                                <td>
                                    {% if stats.quality.pass_rate >= 95 %}
                                    <span class="badge bg-success">Excellent</span>
                                    {% elif stats.quality.pass_rate >= 90 %}
                                    <span class="badge bg-warning">Good</span>
                                    {% else %}
                                    <span class="badge bg-danger">Needs Improvement</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <i class="fas fa-arrow-right text-warning"></i>
                                </td>
                                <td>
                                    {% if stats.quality.pass_rate < 95 %}
                                    Implement quality improvements
                                    {% else %}
                                    Continue quality standards
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Inventory Turnover</strong></td>
                                <td>{{ stats.inventory.stock_health }}%</td>
                                <td>90%</td>
                                <td>
                                    {% if stats.inventory.stock_health >= 90 %}
                                    <span class="badge bg-success">Healthy</span>
                                    {% elif stats.inventory.stock_health >= 75 %}
                                    <span class="badge bg-warning">Monitor</span>
                                    {% else %}
                                    <span class="badge bg-danger">Action Needed</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <i class="fas fa-arrow-down text-danger"></i>
                                </td>
                                <td>
                                    {% if stats.inventory.stock_health < 90 %}
                                    Review stock levels and reorder points
                                    {% else %}
                                    Optimize inventory management
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>On-time Delivery</strong></td>
                                <td>88%</td>
                                <td>95%</td>
                                <td><span class="badge bg-warning">Below Target</span></td>
                                <td><i class="fas fa-arrow-up text-success"></i></td>
                                <td>Improve production scheduling</td>
                            </tr>
                            <tr>
                                <td><strong>Equipment Utilization</strong></td>
                                <td>75%</td>
                                <td>80%</td>
                                <td><span class="badge bg-warning">Below Target</span></td>
                                <td><i class="fas fa-arrow-right text-warning"></i></td>
                                <td>Optimize machine scheduling</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Reports</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <div class="mb-3">
                        <label for="reportType" class="form-label">Report Type</label>
                        <select class="form-select" id="reportType">
                            <option value="summary">Executive Summary</option>
                            <option value="production">Production Report</option>
                            <option value="quality">Quality Report</option>
                            <option value="inventory">Inventory Report</option>
                            <option value="all">Complete Dashboard</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="exportFormat" class="form-label">Format</label>
                        <select class="form-select" id="exportFormat">
                            <option value="pdf">PDF</option>
                            <option value="excel">Excel</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="dateRange" class="form-label">Date Range</label>
                        <select class="form-select" id="dateRange">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div id="customDateRange" class="d-none">
                        <div class="row">
                            <div class="col-6">
                                <label for="startDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="startDate">
                            </div>
                            <div class="col-6">
                                <label for="endDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="endDate">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="generateReport()">Generate Report</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Production Trends Chart
const productionCtx = document.getElementById('productionChart').getContext('2d');
const productionChart = new Chart(productionCtx, {
    type: 'line',
    data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
        datasets: [{
            label: 'Work Orders Completed',
            data: [12, 15, 18, 14, 20, 16],
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            tension: 0.3,
            fill: true
        }, {
            label: 'Work Orders Created',
            data: [15, 18, 20, 16, 22, 18],
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Quality Distribution Chart
const qualityCtx = document.getElementById('qualityChart').getContext('2d');
const qualityChart = new Chart(qualityCtx, {
    type: 'doughnut',
    data: {
        labels: ['Passed', 'Failed', 'Pending'],
        datasets: [{
            data: [{{ stats.quality.passed_inspections }}, {{ stats.quality.failed_inspections }}, 
                   {{ stats.quality.total_inspections - stats.quality.passed_inspections - stats.quality.failed_inspections }}],
            backgroundColor: [
                'rgb(34, 197, 94)',
                'rgb(239, 68, 68)',
                'rgb(156, 163, 175)'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});

// Work Order Status Chart
const workOrderCtx = document.getElementById('workOrderChart').getContext('2d');
const workOrderChart = new Chart(workOrderCtx, {
    type: 'bar',
    data: {
        labels: ['Created', 'Scheduled', 'In Progress', 'Completed', 'Cancelled'],
        datasets: [{
            label: 'Work Orders',
            data: [5, 8, {{ stats.production.in_progress_work_orders }}, {{ stats.production.completed_work_orders }}, 2],
            backgroundColor: [
                'rgba(156, 163, 175, 0.8)',
                'rgba(59, 130, 246, 0.8)',
                'rgba(245, 158, 11, 0.8)',
                'rgba(34, 197, 94, 0.8)',
                'rgba(239, 68, 68, 0.8)'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Inventory Status Chart
const inventoryCtx = document.getElementById('inventoryChart').getContext('2d');
const inventoryChart = new Chart(inventoryCtx, {
    type: 'bar',
    data: {
        labels: ['Good Stock', 'Low Stock', 'Out of Stock'],
        datasets: [{
            label: 'Tools',
            data: [{{ stats.inventory.total_tools - stats.inventory.low_stock_tools }}, {{ stats.inventory.low_stock_tools }}, 0],
            backgroundColor: [
                'rgba(34, 197, 94, 0.8)',
                'rgba(245, 158, 11, 0.8)',
                'rgba(239, 68, 68, 0.8)'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Functions
function refreshData() {
    // In a real application, this would refresh the data from the server
    alert('Data would be refreshed from the server');
    location.reload();
}

function exportReports() {
    new bootstrap.Modal(document.getElementById('exportModal')).show();
}

function generateReport() {
    const reportType = document.getElementById('reportType').value;
    const format = document.getElementById('exportFormat').value;
    const dateRange = document.getElementById('dateRange').value;
    
    // In a real application, this would generate and download the report
    alert(`Generating ${reportType} report in ${format} format for ${dateRange}`);
    bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
}

// Date range handling
document.getElementById('dateRange').addEventListener('change', function() {
    const customDateRange = document.getElementById('customDateRange');
    if (this.value === 'custom') {
        customDateRange.classList.remove('d-none');
    } else {
        customDateRange.classList.add('d-none');
    }
});

// Auto-refresh every 5 minutes
setInterval(function() {
    console.log('Auto-refreshing dashboard data...');
    // In production, this would update charts with new data
}, 300000);
</script>
{% endblock %}
