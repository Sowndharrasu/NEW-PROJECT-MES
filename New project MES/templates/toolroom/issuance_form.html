{% extends "base.html" %}

{% block title %}{{ title }} - Manufacturing ERP System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h1 class="h3 mb-3">
            <i class="fas fa-hand-holding me-2"></i>{{ title }}
        </h1>
    </div>
    <div class="col-md-6 text-end">
        <a href="{{ url_for('main.tool_issuances_list') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to List
        </a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST">
            {{ form.hidden_tag() }}
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.issue_number.label(class="form-label") }}
                        {% if form.issue_number.errors %}
                            {{ form.issue_number(class="form-control is-invalid") }}
                            <div class="invalid-feedback">
                                {% for error in form.issue_number.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ form.issue_number(class="form-control") }}
                        {% endif %}
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.issue_date.label(class="form-label") }}
                        {% if form.issue_date.errors %}
                            {{ form.issue_date(class="form-control is-invalid") }}
                            <div class="invalid-feedback">
                                {% for error in form.issue_date.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ form.issue_date(class="form-control") }}
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.tool_id.label(class="form-label") }}
                        {% if form.tool_id.errors %}
                            {{ form.tool_id(class="form-select is-invalid", id="toolSelect") }}
                            <div class="invalid-feedback">
                                {% for error in form.tool_id.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ form.tool_id(class="form-select", id="toolSelect") }}
                        {% endif %}
                        <div class="form-text">Available quantity will be shown for selected tool</div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.employee_id.label(class="form-label") }}
                        {% if form.employee_id.errors %}
                            {{ form.employee_id(class="form-select is-invalid") }}
                            <div class="invalid-feedback">
                                {% for error in form.employee_id.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ form.employee_id(class="form-select") }}
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.work_order_id.label(class="form-label") }}
                        {% if form.work_order_id.errors %}
                            {{ form.work_order_id(class="form-select is-invalid") }}
                            <div class="invalid-feedback">
                                {% for error in form.work_order_id.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ form.work_order_id(class="form-select") }}
                        {% endif %}
                        <div class="form-text">Optional - Link to specific work order</div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.quantity_issued.label(class="form-label") }}
                        {% if form.quantity_issued.errors %}
                            {{ form.quantity_issued(class="form-control is-invalid", id="quantityIssued") }}
                            <div class="invalid-feedback">
                                {% for error in form.quantity_issued.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ form.quantity_issued(class="form-control", id="quantityIssued") }}
                        {% endif %}
                        <div id="availabilityCheck" class="form-text"></div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.expected_return_date.label(class="form-label") }}
                        {% if form.expected_return_date.errors %}
                            {{ form.expected_return_date(class="form-control is-invalid") }}
                            <div class="invalid-feedback">
                                {% for error in form.expected_return_date.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ form.expected_return_date(class="form-control") }}
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Tool Issuance Guidelines:</strong>
                <ul class="mb-0 mt-2">
                    <li>Ensure the employee returns the tool by the expected return date</li>
                    <li>Tools can be issued for specific work orders or general use</li>
                    <li>Monitor tool usage and condition upon return</li>
                    <li>Tools with calibration requirements need periodic verification</li>
                </ul>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-hand-holding me-2"></i>Issue Tool
                    </button>
                    <a href="{{ url_for('main.tool_issuances_list') }}" class="btn btn-secondary ms-2">
                        Cancel
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toolSelect = document.getElementById('toolSelect');
    const quantityInput = document.getElementById('quantityIssued');
    const availabilityCheck = document.getElementById('availabilityCheck');
    const submitBtn = document.getElementById('submitBtn');
    
    // Set default issue date to today
    const issueDateInput = document.querySelector('input[name="issue_date"]');
    if (issueDateInput && !issueDateInput.value) {
        issueDateInput.value = new Date().toISOString().split('T')[0];
    }
    
    // Set default expected return date to 7 days from now
    const returnDateInput = document.querySelector('input[name="expected_return_date"]');
    if (returnDateInput && !returnDateInput.value) {
        const returnDate = new Date();
        returnDate.setDate(returnDate.getDate() + 7);
        returnDateInput.value = returnDate.toISOString().split('T')[0];
    }
    
    function checkAvailability() {
        const selectedTool = toolSelect.options[toolSelect.selectedIndex];
        const quantityRequested = parseInt(quantityInput.value) || 0;
        
        if (selectedTool && selectedTool.text.includes('Available:')) {
            const availableMatch = selectedTool.text.match(/Available:\s*(\d+)/);
            if (availableMatch) {
                const available = parseInt(availableMatch[1]);
                
                if (quantityRequested > available) {
                    availabilityCheck.innerHTML = `<span class="text-danger">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Insufficient quantity! Available: ${available}
                    </span>`;
                    submitBtn.disabled = true;
                } else if (quantityRequested > 0) {
                    availabilityCheck.innerHTML = `<span class="text-success">
                        <i class="fas fa-check-circle me-1"></i>
                        Available: ${available}, Remaining after issue: ${available - quantityRequested}
                    </span>`;
                    submitBtn.disabled = false;
                } else {
                    availabilityCheck.innerHTML = '';
                    submitBtn.disabled = false;
                }
            }
        }
    }
    
    toolSelect.addEventListener('change', checkAvailability);
    quantityInput.addEventListener('input', checkAvailability);
    
    // Initial check
    checkAvailability();
});
</script>
{% endblock %}
